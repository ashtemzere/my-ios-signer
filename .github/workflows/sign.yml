name: Universal iOS Signer
on:
  workflow_dispatch:
    inputs:
      ipa_links:
        description: 'لێرە یەک لینک یان چەند لینک دابنێ (بە فاریزە "," جیایان بکەرەوە)'
        required: true
      p12_password:
        description: 'پاسۆردی بڕوانامە'
        required: true
        default: '@ashtemobile'

jobs:
  sign:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install ZSign
        run: |
          # داگرتنی وەشانی ئامادەکراو بۆ ئەوەی تووشی هەڵەی *.cpp نەبیت
          wget https://github.com/zhlynn/zsign/releases/download/v0.1/zsign_linux_x86_64.tar.gz
          tar -xzf zsign_linux_x86_64.tar.gz
          chmod +x zsign
          sudo mv zsign /usr/local/bin/

      - name: Process Signing
        run: |
          mkdir -p signed_output
          # کۆدەکە یەک لینک یان چەند لینک بێت جیاکاری دەکات
          IFS=',' read -ra LINKS <<< "${{ github.event.inputs.ipa_links }}"
          for link in "${LINKS[@]}"; do
            clean_link=$(echo $link | xargs)
            filename=$(basename "$clean_link")
            echo "خەریکی داگرتنی: $filename"
            curl -L "$clean_link" -o "$filename"
            
            echo "خەریکی واژۆکردنی: $filename"
            # بەکارهێنانی فایلەکانی cert.p12 و dev.mobileprovision لە ڕێپۆزیتۆرییەکەدا
            zsign -k cert.p12 -p "${{ github.event.inputs.p12_password }}" -m dev.mobileprovision -o "signed_output/s_$filename" "$filename"
            rm "$filename"
          done

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: "Signed Apps - Build ${{ github.run_number }}"
          files: signed_output/*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
