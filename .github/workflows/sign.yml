name: Auto Sign IPA
on:
  workflow_dispatch:
  push:
    paths:
      - 'uploads/**'

jobs:
  sign-ipa:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y git make g++ libzip-dev openssl jq

      - name: Clone and build ZSign
        run: |
          git clone https://github.com/zhlynn/zsign.git
          cd zsign
          make
          # Ú¯ÙˆØ§Ø³ØªÙ†Û•ÙˆÛ•ÛŒ ÙØ§ÛŒÙ„Û• Ø¬ÛŽØ¨Û•Ø¬ÛŽÚ©Ø§Ø±Û•Ú©Û• Ø¨Û† Ø´ÙˆÛŽÙ†ÛŒ Ø³Û•Ø±Û•Ú©ÛŒ Ø¨Û† Ø¯Û•Ø³ØªÚ•Ø§Ú¯Û•ÛŒØ´ØªÙ†ÛŒ Ø¦Ø§Ø³Ø§Ù†ØªØ±
          sudo cp zsign /usr/local/bin/zsign
          
      - name: Find and sign IPA files
        run: |
          # Ú¯Û•Ú•Ø§Ù† Ø¨Û† ÙØ§ÛŒÙ„Û•Ú©Ø§Ù† Ù„Û• Ù†Ø§Ùˆ ÙÛ†ÚµØ¯Û•Ø±ÛŒ uploads
          IPA_FILE=$(find uploads -name "*.ipa" | head -1)
          P12_FILE=$(find uploads -name "*.p12" | head -1)
          PROVISION_FILE=$(find uploads -name "*.mobileprovision" | head -1)
          
          # Ù¾Ø´Ú©Ù†ÛŒÙ†ÛŒ Ù‡Û•Ø¨ÙˆÙˆÙ†ÛŒ ÙØ§ÛŒÙ„ÛŒ config.json
          if [ -f "config.json" ]; then
            PASSWORD=$(jq -r '.password' config.json)
          else
            echo "âŒ Error: config.json not found!"
            exit 1
          fi

          # Ù¾Ø´Ú©Ù†ÛŒÙ†ÛŒ Ø¦Û•ÙˆÛ•ÛŒ Ø¦Ø§ÛŒØ§ Ù‡Û•Ù…ÙˆÙˆ ÙØ§ÛŒÙ„Û•Ú©Ø§Ù† Ø¯Û†Ø²Ø±Ø§ÙˆÙ†Û•ØªÛ•ÙˆÛ•
          if [ -z "$IPA_FILE" ] || [ -z "$P12_FILE" ] || [ -z "$PROVISION_FILE" ]; then
            echo "âŒ Error: One or more files are missing in 'uploads/' folder."
            echo "Found IPA: $IPA_FILE"
            echo "Found P12: $P12_FILE"
            echo "Found MobileProvision: $PROVISION_FILE"
            exit 1
          fi

          echo "ðŸ“¦ Starting Signing Process..."
          zsign -k "$P12_FILE" -p "$PASSWORD" -m "$PROVISION_FILE" -o "signed_app.ipa" "$IPA_FILE"
          echo "âœ… Signing Completed!"

      - name: Upload signed IPA
        uses: actions/upload-artifact@v4
        with:
          name: signed-ipa
          path: signed_app.ipa

      - name: Create Summary
        run: |
          echo "### âœ… ÙˆÛŽÙ†Û•Ú¯Ø±ÛŒ Ø³Û•Ø±Ú©Û•ÙˆØªÙˆÙˆ Ø¨ÙˆÙˆ" >> $GITHUB_STEP_SUMMARY
          echo "Ø¯Û•ØªÙˆØ§Ù†ÛŒØª ÙØ§ÛŒÙ„ÛŒ Ø³Ø§ÛŒÙ†Ú©Ø±Ø§Ùˆ Ù„Û• Ø¨Û•Ø´ÛŒ **Artifacts** Ø¯Ø§Ø¨Ú¯Ø±ÛŒØª." >> $GITHUB_STEP_SUMMARY
